name: Build & Deploy to Lab (Docker)

on:
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo for debugging
        run: |
          echo "repo root: $(pwd)"
          git rev-parse --show-toplevel
          echo "---- list top-level ----"
          ls -la
          echo "---- list web project ----"
          ls -la TailwindTraders.Website/Source/Tailwind.Traders.Web
          echo "---- show pinned dockerfile path ----"
          test -f TailwindTraders.Website/Source/Tailwind.Traders.Web/Dockerfile && echo "Dockerfile exists"

      - name: Build Docker image (PINNED file + context)
        env:
          DOCKERFILE: TailwindTraders.Website/Source/Tailwind.Traders.Web/Dockerfile
          DOCKER_CONTEXT: TailwindTraders.Website/Source/Tailwind.Traders.Web
        run: |
          echo "Using DOCKERFILE=$DOCKERFILE"
          echo "Using DOCKER_CONTEXT=$DOCKER_CONTEXT"
          docker build -t twt-web:latest -f "$DOCKERFILE" "$DOCKER_CONTEXT"

      - name: Replace running container
        run: |
          docker rm -f twt-web || true
          docker run -d --name twt-web -p 8080:8080 twt-web:latest
          docker ps -a
